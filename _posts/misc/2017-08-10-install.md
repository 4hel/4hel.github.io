---
layout: post
title:  "Kubernetes Installation on Debian"
date:   2017-08-10 12:20:00
categories: kubernetes
---

Install Kubernetes on Debian

## 1. Install Docker

```bash
curl -fsSL https://download.docker.com/linux/debian/gpg | sudo apt-key add -
sudo add-apt-repository \
   "deb [arch=amd64] https://download.docker.com/linux/debian \
   $(lsb_release -cs) \
   stable"
sudo apt-get update
sudo apt-get install docker-ce
```

On Production specify docker version

```bash
apt-cache madison docker-ce
#
# outputs available version
#
sudo apt-get install docker-ce=<VERSION_STRING>
```

## 2. Install kubelet and kubeadm on every machine

```bash
apt-get update && apt-get install -y apt-transport-https
curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -
cat <<EOF >/etc/apt/sources.list.d/kubernetes.list
deb http://apt.kubernetes.io/ kubernetes-xenial main
EOF
apt-get update
apt-get install -y kubelet kubeadm
#
kubeadm version
kubelet --version
```

## 3. Initialize Master

```bash
kubeadm init --pod-network-cidr=10.244.0.0/16
#
# remember token line from output
#
kubeadm token list
```

## 4. Configure kubectl

For a regular user copy `/etc/kubernetes/admin.conf` to `$HOME`.
Export the environment varibale KUBECONFIG to point to `$HOME/admin.conf`

For root do:

```bash
echo "export KUBECONFIG=/etc/kubernetes/admin.conf" >> /root/.bashrc
```

## 5. Install Flannel

```bash
cd /root
wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel-rbac.yml
wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
```

In a Virtual Machine the network interface must be added in the file kube-flannel.yml'

the line:

`command: [ "/opt/bin/flanneld", "--ip-masq", "--kube-subnet-mgr" ]`

needs to be changed to:

`command: [ "/opt/bin/flanneld", "--ip-masq", "--kube-subnet-mgr", "--iface=ens192" ]`

Then do:

```bash
kubectl create -f kube-flannel-rbac.yml
kubectl create -f kube-flannel.yml
#
# check with:
#
kubectl get pods --all-namespaces
```

## 6. Configure Nodes

Do steps 1. und 2.

## 7. Fix Flannel Forwarding

```bash
iptables -P FORWARD ACCEPT
```
