---
layout: post
title:  "vault"
date:   2019-02-02 10:00:00
categories: devops
---

* TOC
{:toc}

## CRUD features to store arbitrary secrets

Starting the **Dev Server**.
It stores Data in-memory and listens on localhost without TLS.
It automatically unseals and shows you the unseal key and root access key.

```bash
vault server -dev
```

Configuring the Client

```bash
export VAULT_ADDR='http://127.0.0.1:8200'
export VAULT_DEV_ROOT_TOKEN_ID=
```

Check Status

```bash
vault status
```

Writing and Reading a **Secret** with the **Path** `secret/hello`

```bash
vault kv put secret/hello foo=world excited=yes
```

```bash
vault kv get secret/hello
```

**JSON** is also possible with `-format=json`

and getting a **Field** directly

```bash
vault kv get -field=foo secret/hello
```

**Deleting** a Secret

```bash
vault kv delete secret/hello
```


## Secret Engines

By default, Vault enables a secrets engine called `kv` at the path `secret/`

For example the `aws` secrets engine generates AWS IAM access keys on demand.
The `database` secrets engine generates on-demand , time-limited database credentials.

### Enable a Secrets Engine

```bash
vault secrets enable -path=kv kv
```

Because the path defaults to the name of the secret engine this is also possible

```bash
vault secrets enable kv
```

To get more information do a **list** for secrets

```
vault secrets list
```

To see all keys in an do a **list**

```
vault list kv
```

### Disable a Secrets Engine

When a Secrets Engine is disabled, all secrets are revoked and the corresponding vault data and configuration is removed.

```
vault secrets disable kv/
```

### What is a Secrets Engine?

Vault behaves similarly to a virtual filesystem. The read/write/delete/list operations are forwarded to the corresponding secrets engine.
This is a good abstraction. Vault can interact with environments like AWS IAM, dynamic SQL user creation, etc. all using the same read/write interface.


## Dynamic Secrets

```bash
vault secrets enable aws
```

```bash
vault write aws/config/root \
    access_key=AKIAI4SGLQPBX6CSENIQ \
    secret_key=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 \
    region=us-east-1
```

### Create a Role

```bash
vault write aws/roles/my-role \
        credential_type=iam_user \
        policy_document=-<<EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "Stmt1426528957000",
      "Effect": "Allow",
      "Action": [
        "ec2:*"
      ],
      "Resource": [
        "*"
      ]
    }
  ]
}
EOF
```

## Generating a Secret

Now that the aws secrets engine is configured with a role, we can ask Vault to generate an access key par for that role by reading from `aws/creds/:role`:

```bash
vault read aws/creds/my-role
```

## Revoke a Secret

To revoke a secret use `vault revoke` with the lease ID:

```bash
vault lease revoke aws/creds/my-role/0bce0782-32aa-25ec-f61d-c026ff22106
```

